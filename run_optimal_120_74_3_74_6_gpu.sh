#!/bin/bash
# GPU ะฟะพะธัะบ ะฝะฐ ัะตัะฒะตัะต: window_avg (ะธะท ANALYZE.txt), ัะทะบะพะต ะพะบะฝะพ ะฒะพะบััะณ 87.9978%
# 120 ัะตะณะผะตะฝัะพะฒ (ัะตัะตะดะพะฒะฐะฝะธะต up/down), ะฟะฐััะตัะฝั ัะตัะตะท -i + ะฑะฐะทะพะฒัะน PATTERN ะฑะตะท wildcard ะดะปั ะฒัะฒะพะดะฐ Prob
# ะฆะะะฌ: 1PWo3JeB9jrGwfHDNpdGK54CRas7fsVzXU (Bitcoin Puzzle #71)
# ะะะะะ: ะัะตะดัะดััะธะต ะฟัะพัะตััั VanitySearch ะะ ะพััะฐะฝะฐะฒะปะธะฒะฐัััั!

set -eo pipefail  # ะฃะฑัะฐะปะธ -u ััะพะฑั ะฝะต ะฟะฐะดะฐัั ะฝะฐ ะฝะตะพะฟัะตะดะตะปัะฝะฝัั ะฟะตัะตะผะตะฝะฝัั

# ะะฐัะฐะผะตััั
SEG_FILE="seg_optimal_120_winAvg_87_698_88_298.txt"
OUT_FILE="out_optimal_120_winAvg_87_698_88_298.txt"
LOG_FILE="log_optimal_120_winAvg_87_698_88_298.log"
PROGRESS_FILE="progress_optimal_120_winAvg_87_698_88_298.dat"
PATTERNS_FILE="patterns_target_pack.txt"   # ะดะปั -i (ัะผ. VanitySearch/ANALYZE.txt -> TARGET PACK)
PATTERN="1PWo3JeB"  # ะะะ wildcard โ VanitySearch ะฟะตัะฐัะฐะตั Prob ะดะปั ัะฐะบะพะณะพ ะฟัะตัะธะบัะฐ
BITS=71
GPU_ID=0  # ะะทะผะตะฝะธัะต ะฝะฐ ะฝัะถะฝัะน GPU ะธะปะธ ะธัะฟะพะปัะทัะนัะต ะฝะตัะบะพะปัะบะพ: 0,1,2,3
GRID="128,256"  # ะะปั RTX 4090. ะัะปะธ OOM, ัะผะตะฝััะธัะต: 64,128 ะธะปะธ 32,128
CPU_THREADS=2  # ะะฐ GPU ะพะฑััะฝะพ ัะฒะฐัะฐะตั 1-4 (ะปะธัะฝะธะต CPU ะฟะพัะพะบะธ ะผะพะณัั ะผะตัะฐัั ัะธััะตะผะต)
MAXFOUND=10000000  # ะฃะฒะตะปะธัะตะฝะฝัะน ะฑััะตั ะดะปั ะฟัะตะดะพัะฒัะฐัะตะฝะธั ะฟะตัะตะฟะพะปะฝะตะฝะธั (10 ะผะธะปะปะธะพะฝะพะฒ)
AUTOSAVE_INTERVAL=60  # ะะฒัะพัะพััะฐะฝะตะฝะธะต ะบะฐะถะดัะต 1 ะผะธะฝัั

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  ๐ฏ ะฃะะะะ ะะะะกะ PUZZLE #71 (window_avg: 87.6978%..88.2978%)                โ"
echo "โ  120 ัะตะณะผะตะฝัะพะฒ (up/down), ะฟะฐััะตัะฝั: -i + ะฑะฐะทะพะฒัะน ะฟัะตัะธะบั                   โ"
echo "โ  โ๏ธ  ะัะตะดัะดััะธะต ะฟัะพัะตััั VanitySearch ะะ ะพััะฐะฝะฐะฒะปะธะฒะฐัััั!                   โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "=== ะะพะฝัะธะณััะฐัะธั ==="
echo "SEG_FILE=$SEG_FILE"
echo "OUT_FILE=$OUT_FILE"
echo "LOG_FILE=$LOG_FILE"
echo "PROGRESS_FILE=$PROGRESS_FILE"
echo "PATTERNS_FILE=$PATTERNS_FILE (ะดะปั -i)"
echo "PATTERN=$PATTERN (ะะะ wildcard ะดะปั ะฒัะฒะพะดะฐ Prob)"
echo "BITS=$BITS"
echo "GPU_ID=$GPU_ID"
echo "GRID=$GRID"
echo "CPU_THREADS=$CPU_THREADS"
echo "MAXFOUND=$MAXFOUND"
echo "AUTOSAVE_INTERVAL=${AUTOSAVE_INTERVAL} ัะตะบ"
echo ""

# ะัะพะฒะตัะบะฐ ัะฐะนะปะฐ ัะตะณะผะตะฝัะพะฒ
if [ ! -f "$SEG_FILE" ]; then
    echo "โ ะัะธะฑะบะฐ: ัะฐะนะป ัะตะณะผะตะฝัะพะฒ $SEG_FILE ะฝะต ะฝะฐะนะดะตะฝ!"
    echo "   ะกะบะพะฟะธััะนัะต $SEG_FILE ะฝะฐ ัะตัะฒะตั"
    exit 1
fi

# ะัะพะฒะตัะบะฐ ัะฐะนะปะฐ ะฟะฐััะตัะฝะพะฒ
if [ ! -f "$PATTERNS_FILE" ]; then
    echo "โ ะัะธะฑะบะฐ: ัะฐะนะป ะฟะฐััะตัะฝะพะฒ $PATTERNS_FILE ะฝะต ะฝะฐะนะดะตะฝ!"
    echo "   ะกะบะพะฟะธััะนัะต $PATTERNS_FILE ะฝะฐ ัะตัะฒะตั"
    exit 1
fi

# ะะะะะ: VanitySearch -i ะะ ะธะณะฝะพัะธััะตั ะบะพะผะผะตะฝัะฐัะธะธ: ะปัะฑะฐั ะฝะตะฟัััะฐั ัััะพะบะฐ = ะฟะฐััะตัะฝ.
# ะะพััะพะผั ะทะดะตัั ะฒัะตะณะดะฐ ะดะตะปะฐะตะผ "clean" ัะฐะนะป (ัะฑะธัะฐะตะผ ะฟััััะต ัััะพะบะธ ะธ ัััะพะบะธ, ะฝะฐัะธะฝะฐััะธะตัั ั # ะธะปะธ ;).
PATTERNS_FILE_CLEAN="${PATTERNS_FILE}.clean"
grep -vE '^[[:space:]]*$' "$PATTERNS_FILE" | grep -vE '^[[:space:]]*[#;]' > "$PATTERNS_FILE_CLEAN"
if [ ! -s "$PATTERNS_FILE_CLEAN" ]; then
    echo "โ ะัะธะฑะบะฐ: ะฟะพัะปะต ะพัะธััะบะธ $PATTERNS_FILE_CLEAN ะฟัััะพะน (ะฟัะพะฒะตัััะต ัะพะดะตัะถะธะผะพะต $PATTERNS_FILE)"
    exit 1
fi

# ะะะะะ (GPU + wildcard):
# ะ ัะตะบััะตะน ัะตะฐะปะธะทะฐัะธะธ GPU-ัะดัะพ ะธัะฟะพะปัะทัะตั ะขะะะฌะะ ะะะะะซะ ะฟะฐััะตัะฝ ะธะท ัะฟะธัะบะฐ (-i),
# ะฟะพััะพะผั ะฟะตัะฒัะน ะฟะฐััะตัะฝ ะดะพะปะถะตะฝ ะฑััั "ัะธัะพะบะธะผ ัะธะปัััะพะผ", ะฐ ะฒัะต ะพััะฐะปัะฝัะต โ ะตะณะพ ะฟะพะดะผะฝะพะถะตััะฒะพะผ.
# ะะดะตัั ะฟัะธะฝัะดะธัะตะปัะฝะพ ะดะตะปะฐะตะผ ะฟะตัะฒัะผ ะฟะฐััะตัะฝะพะผ "${PATTERN}*" (ะฟะพะธัะบ ะฟะพ ะฟัะตัะธะบัั),
# ััะพะฑั GPU ะฝะฐัะฐะป ะฒะพะทะฒัะฐัะฐัั ะบะฐะฝะดะธะดะฐัั, ะฐ CPU ัะถะต ะฟัะพะฒะตัะธั ะพััะฐะปัะฝัะต ัััะพะบะธ ะธะท -i.
PATTERNS_FILE_GPU="${PATTERNS_FILE}.gpu"
{
  echo "${PATTERN}*"
  # ะดะพะฑะฐะฒะปัะตะผ ะพััะฐะปัะฝัะต ะฟะฐััะตัะฝั, ะบัะพะผะต ัะพัะฝะพะณะพ "${PATTERN}" (ะพะฝ ะฒ wildcard-ัะตะถะธะผะต = ะฟะพะปะฝะพะต ัะพะฒะฟะฐะดะตะฝะธะต ัััะพะบะธ ะธ ะฒัะตะณะดะฐ 0)
  grep -v -x "${PATTERN}" "$PATTERNS_FILE_CLEAN" || true
} | awk '!seen[$0]++' > "$PATTERNS_FILE_GPU"
if [ ! -s "$PATTERNS_FILE_GPU" ]; then
    echo "โ ะัะธะฑะบะฐ: ะธัะพะณะพะฒัะน ัะฐะนะป ะฟะฐััะตัะฝะพะฒ ะดะปั GPU ะฟัััะพะน: $PATTERNS_FILE_GPU"
    exit 1
fi

# ะัะพะฒะตัะบะฐ VanitySearch
if [ ! -f "./VanitySearch" ]; then
    echo "โ ะัะธะฑะบะฐ: VanitySearch ะฝะต ะฝะฐะนะดะตะฝ!"
    echo "   ะกะพะฑะตัะธัะต ะฟัะพะตะบั: make clean && make gpu=1 CCAP=8.9 all -j\"\$(nproc)\""
    exit 1
fi

# ะัะพะฒะตัะบะฐ, ััะพ ะผะพะถะตะผ ะฟะธัะฐัั out/log/progress ะฒ ัะตะบัััั ะดะธัะตะบัะพัะธั
touch "$OUT_FILE" 2>/dev/null || { echo "โ ะะตั ะฟัะฐะฒ ัะพะทะดะฐัั/ะฟะธัะฐัั OUT_FILE=$OUT_FILE (ะฟัะพะฒะตัััะต ะฟะฐะฟะบั ะทะฐะฟััะบะฐ)"; exit 1; }
touch "$LOG_FILE" 2>/dev/null || { echo "โ ะะตั ะฟัะฐะฒ ัะพะทะดะฐัั/ะฟะธัะฐัั LOG_FILE=$LOG_FILE (ะฟัะพะฒะตัััะต ะฟะฐะฟะบั ะทะฐะฟััะบะฐ)"; exit 1; }
touch "$PROGRESS_FILE" 2>/dev/null || { echo "โ ะะตั ะฟัะฐะฒ ัะพะทะดะฐัั/ะฟะธัะฐัั PROGRESS_FILE=$PROGRESS_FILE (ะฟัะพะฒะตัััะต ะฟะฐะฟะบั ะทะฐะฟััะบะฐ)"; exit 1; }

# ะัะพะฒะตัะบะฐ ัััะตััะฒัััะธั ะฟัะพัะตััะพะฒ (ะะ ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ!)
EXISTING_PROCESSES=$(ps aux | grep '[V]anitySearch' 2>/dev/null | wc -l || echo "0")
if [ "$EXISTING_PROCESSES" -gt 0 ]; then
    echo "โน๏ธ  ะะฐะนะดะตะฝะพ $EXISTING_PROCESSES ะฐะบัะธะฒะฝัั ะฟัะพัะตััะพะฒ VanitySearch"
    echo "   ะะฝะธ ะฟัะพะดะพะปะถะฐั ัะฐะฑะพัะฐัั ะฟะฐัะฐะปะปะตะปัะฝะพ ั ะฝะพะฒัะผ ะฟะพะธัะบะพะผ"
    echo ""
    ps aux | grep '[V]anitySearch' 2>/dev/null | grep -v grep | head -5 || true
    echo ""
fi

# ะะฒัะพะผะฐัะธัะตัะบะธะน resume ะตัะปะธ ะตััั progress ัะฐะนะป
RESUME_FLAG=""
if [ -f "$PROGRESS_FILE" ]; then
    echo "โน๏ธ  ะะฐะนะดะตะฝ ัะฐะนะป ะฟัะพะณัะตััะฐ, ะฑัะดะตั ะธัะฟะพะปัะทะพะฒะฐะฝ -resume"
    RESUME_FLAG="-resume"
else
    RESUME_FLAG=""  # ะฏะฒะฝะพ ัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟััััั ัััะพะบั
fi

echo "โ ะะฐะฟััะบ ะฝะพะฒะพะณะพ GPU ะฟะพะธัะบะฐ (ะฟะฐัะฐะปะปะตะปัะฝะพ ั ัััะตััะฒัััะธะผะธ)..."
echo ""

# ะะฐะฟััะบ ั nohup ะดะปั ัะฐะฑะพัั ะฒ ัะพะฝะต
# ะัะฟะพะปัะทัะตะผ eval ะดะปั ะฟัะฐะฒะธะปัะฝะพะน ะพะฑัะฐะฑะพัะบะธ ะฟัััะพะณะพ RESUME_FLAG
if [ -n "$RESUME_FLAG" ]; then
    nohup ./VanitySearch \
        -seg "$SEG_FILE" \
        -bits $BITS \
        $RESUME_FLAG \
        -progress "$PROGRESS_FILE" \
        -autosave $AUTOSAVE_INTERVAL \
        -gpu \
        -gpuId $GPU_ID \
        -g $GRID \
        -t $CPU_THREADS \
        -m $MAXFOUND \
        -o "$OUT_FILE" \
        -i "$PATTERNS_FILE_GPU" \
        "$PATTERN" \
        > "$LOG_FILE" 2>&1 &
else
    nohup ./VanitySearch \
        -seg "$SEG_FILE" \
        -bits $BITS \
        -progress "$PROGRESS_FILE" \
        -autosave $AUTOSAVE_INTERVAL \
        -gpu \
        -gpuId $GPU_ID \
        -g $GRID \
        -t $CPU_THREADS \
        -m $MAXFOUND \
        -o "$OUT_FILE" \
        -i "$PATTERNS_FILE_GPU" \
        "$PATTERN" \
        > "$LOG_FILE" 2>&1 &
fi

PID=$!
sleep 2  # ะะฐัะผ ะฟัะพัะตััั ะฒัะตะผั ะทะฐะฟัััะธัััั

# ะัะพะฒะตัะบะฐ, ััะพ ะฟัะพัะตัั ะดะตะนััะฒะธัะตะปัะฝะพ ะทะฐะฟัััะธะปัั (ัะฝะธะฒะตััะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ)
if kill -0 $PID 2>/dev/null || ps aux | grep -q "^[^ ]* *$PID " 2>/dev/null; then
    echo "โ ะะฐะฟััะตะฝะพ ััะฟะตัะฝะพ. PID=$PID"
    echo ""
    echo "๐ ะะตัะฒัะต ัััะพะบะธ ะปะพะณะฐ (ะฟัะพะฒะตัะบะฐ ะทะฐะฟััะบะฐ):"
    tail -10 "$LOG_FILE" 2>/dev/null || echo "   (ะปะพะณ ะตัั ะฟััั ะธะปะธ ะฝะตะดะพัััะฟะตะฝ)"
    echo ""
else
    echo "โ ะัะธะฑะบะฐ: ะัะพัะตัั ะฝะต ะทะฐะฟัััะธะปัั ะธะปะธ ััะฐะทั ะทะฐะฒะตััะธะปัั!"
    echo ""
    echo "๐ ะกะพะดะตัะถะธะผะพะต ะปะพะณะฐ (ะฟะพัะปะตะดะฝะธะต 50 ัััะพะบ):"
    tail -50 "$LOG_FILE" 2>/dev/null || echo "   (ะปะพะณ ะฟััั ะธะปะธ ะฝะตะดะพัััะฟะตะฝ)"
    echo ""
    echo "๐ ะะพะทะผะพะถะฝัะต ะฟัะธัะธะฝั:"
    echo "   - ะัะธะฑะบะฐ ะฒ ะฟะฐัะฐะผะตััะฐั VanitySearch"
    echo "   - ะัะพะฑะปะตะผะฐ ั GPU (OOM, ะดัะฐะนะฒะตัั, ะทะฐะฝัั ะดััะณะธะผ ะฟัะพัะตััะพะผ)"
    echo "   - ะัะธะฑะบะฐ ะฒ ัะฐะนะปะต ัะตะณะผะตะฝัะพะฒ"
    echo "   - ะะตะดะพััะฐัะพัะฝะพ ะฟะฐะผััะธ"
    echo ""
    echo "๐ก ะะพะฟัะพะฑัะนัะต ะทะฐะฟัััะธัั ะฒัััะฝัั ะดะปั ะดะธะฐะณะฝะพััะธะบะธ:"
    echo "   ./VanitySearch -seg $SEG_FILE -bits $BITS -gpu -gpuId $GPU_ID -g $GRID -t $CPU_THREADS -m $MAXFOUND -o $OUT_FILE \"$PATTERN\""
    exit 1
fi
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  ๐ ะะะะะะะซะ ะะะะะะะซ                                                       โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ ะะพัะผะพััะตัั ะปะพะณ (ะฟะพัะปะตะดะฝะธะต 50 ัััะพะบ):"
echo "   tail -50 $LOG_FILE"
echo ""
echo "๐ ะกะปะตะดะธัั ะทะฐ ะปะพะณะพะผ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ:"
echo "   tail -f $LOG_FILE"
echo ""
echo "๐ ะะพัะผะพััะตัั ะฟัะพะณัะตัั (ะดะตัะฐะปัะฝัะน):"
echo "   python3 show_segment_progress.py $SEG_FILE $PROGRESS_FILE $OUT_FILE"
echo ""
echo "๐ ะะพัะผะพััะตัั ะฟัะพะณัะตัั (ัะฟัะพััะฝะฝัะน):"
echo "   ./show_segment_progress_simple.sh $SEG_FILE $PROGRESS_FILE"
echo ""
echo "๐ ะะพััะธัะฐัั ะฝะฐะนะดะตะฝะฝัะต ะฐะดัะตัะฐ:"
echo "   grep -c 'PubAddress:' $OUT_FILE 2>/dev/null || echo '0'"
echo ""
echo "๐ฏ ะัะพะฒะตัะธัั, ะฝะฐะนะดะตะฝ ะปะธ ัะตะปะตะฒะพะน ะฐะดัะตั:"
echo "   grep '1PWo3JeB9jrGwfHDNpdGK54CRas7fsVzXU' $OUT_FILE"
echo ""
echo "๐ ะกะฟะธัะพะบ ะะกะะฅ ะฟัะพัะตััะพะฒ VanitySearch:"
echo "   ps aux | grep '[V]anitySearch'"
echo ""
echo "๐ด ะััะฐะฝะพะฒะธัั ะขะะะฌะะ ััะพั ะฟัะพัะตัั:"
echo "   kill $PID"
echo ""
echo "๐พ ะกะดะตะปะฐัั ัะตะทะตัะฒะฝัั ะบะพะฟะธั ะฟัะพะณัะตััะฐ:"
echo "   cp $PROGRESS_FILE ${PROGRESS_FILE}.backup.\$(date +%Y%m%d_%H%M%S)"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  โ๏ธ  ะะะะะซะ ะะะะะะงะะะะฏ                                                     โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "1. โ ะะฐััะตัะฝ '1PWo3JeB' ะะะ ะทะฒะตะทะดะพัะบะธ - Prob ะฑัะดะตั ะฒัะฒะพะดะธัััั!"
echo ""
echo "2. ๐ฅ ะัะปะธ ะฒะธะดะธัะต OOM (out of memory), ัะผะตะฝััะธัะต -g:"
echo "      ะะพะฟัะพะฑัะนัะต: -g 64,128 ะธะปะธ -g 32,128"
echo ""
echo "3. ๐ ะะพะฝะธัะพัััะต GPU:"
echo "      nvidia-smi -l 1  # ะพะฑะฝะพะฒะปะตะฝะธะต ะบะฐะถะดัั ัะตะบัะฝะดั"
echo ""
echo "4. ๐ก ะะถะธะดะฐะตะผะฐั ัะบะพัะพััั:"
echo "      RTX 4090: ~1-2 GKey/s"
echo "      RTX 3090: ~0.8-1.5 GKey/s"
echo ""
echo "5. โฑ๏ธ  ะัะตะผั ะฟะพะบัััะธั ะดะธะฐะฟะฐะทะพะฝะฐ (ะพัะตะฝะบะฐ):"
echo "      ะัะธ 1 GKey/s: ะฝะตัะบะพะปัะบะพ ะดะฝะตะน"
echo "      ะัะธ 10 GKey/s (10 GPU): ะฝะตัะบะพะปัะบะพ ัะฐัะพะฒ"
echo ""
echo "6. ๐ฏ ะญัะพั ะดะธะฐะฟะฐะทะพะฝ ะฃะะะะ (~0.60%):"
echo "      ะัะฝะพะฒะฐะฝะพ ะฝะฐ ะฐะฝะฐะปะธะทะต (ANALYZE.txt): ะพะบะฝะพ window_avg ะฒะพะบััะณ ััะตะดะฝะตะน Puzzle-ะบะพะพัะดะธะฝะฐัั"
echo ""
echo "7. โ๏ธ  ะัะตะดัะดััะธะต ะฟัะพัะตััั ะะ ะพััะฐะฝะพะฒะปะตะฝั:"
echo "      ะะฝะธ ะฟัะพะดะพะปะถะฐั ัะฐะฑะพัะฐัั ะฟะฐัะฐะปะปะตะปัะฝะพ"
echo "      ะัะฟะพะปัะทัะนัะต 'ps aux | grep VanitySearch' ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ ะฒัะตั"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  ๐ ะฃะะะงะ ะ ะะะะกะะ!                                                        โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

